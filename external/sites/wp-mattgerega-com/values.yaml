global:
  nameOverride: wp-mattgerega-com

defaultPodOptions:
  automountServiceAccountToken: false

controllers:
  # WordPress controller - Deployment
  wordpress:
    enabled: true
    type: deployment
    replicas: 1
    strategy: RollingUpdate

    pod:
      securityContext:
        fsGroup: 33  # www-data user
        fsGroupChangePolicy: "OnRootMismatch"

    containers:
      main:
        image:
          repository: docker.io/wordpress
          tag: 6.9.0-apache
          pullPolicy: IfNotPresent

        env:
          WORDPRESS_DB_HOST: "wp-mattgerega-com-mariadb"
          WORDPRESS_DB_NAME: "wordpress"
          WORDPRESS_DB_USER: "wordpress"
          WORDPRESS_DB_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: wp-mg-com-dbsecrets
                key: MARIADB_PASSWORD
          WORDPRESS_CONFIG_EXTRA: |
            /* Force HTTPS */
            if (isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
                $_SERVER['HTTPS'] = 'on';
            }
            define('FORCE_SSL_ADMIN', true);

        probes:
          liveness:
            enabled: true
            type: TCP
            spec:
              initialDelaySeconds: 120
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 6
          readiness:
            enabled: true
            type: HTTP
            spec:
              httpHeaders:
                - name: X-Forwarded-Proto
                  value: https
              path: /wp-login.php
              initialDelaySeconds: 30
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 6

        resources:
          requests:
            cpu: 500m
            memory: 512Mi
            ephemeral-storage: 50Mi
          limits:
            cpu: 750m
            memory: 768Mi
            ephemeral-storage: 2Gi

        securityContext:
          runAsNonRoot: true
          runAsUser: 33  # www-data user
          readOnlyRootFilesystem: false
          allowPrivilegeEscalation: false
          seccompProfile:
            type: RuntimeDefault
          capabilities:
            drop:
              - ALL
            add:
              - CHOWN
              - SETGID
              - SETUID

  # MariaDB controller - StatefulSet
  mariadb:
    enabled: true
    type: statefulset
    replicas: 1

    pod:
      securityContext:
        fsGroup: 999  # mysql user
        fsGroupChangePolicy: "OnRootMismatch"

    statefulset:
      volumeClaimTemplates:
        - name: data
          accessMode: ReadWriteOnce
          size: 8Gi
          storageClass: nfs-client
          globalMounts:
            - path: /var/lib/mysql

    containers:
      main:
        image:
          repository: docker.io/mariadb
          tag: "11.8"
          pullPolicy: IfNotPresent

        env:
          MARIADB_DATABASE: "wordpress"
          MARIADB_USER: "wordpress"
          MARIADB_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: wp-mg-com-dbsecrets
                key: MARIADB_PASSWORD
          MARIADB_ROOT_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: wp-mg-com-dbsecrets
                key: MARIADB_ROOT_PASSWORD

        probes:
          liveness:
            enabled: true
            type: EXEC
            spec:
              command:
                - /bin/sh
                - -c
                - mariadb-admin ping -uroot -p${MARIADB_ROOT_PASSWORD}
              initialDelaySeconds: 120
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 3
          readiness:
            enabled: true
            type: EXEC
            spec:
              command:
                - /bin/sh
                - -c
                - mariadb-admin ping -uroot -p${MARIADB_ROOT_PASSWORD}
              initialDelaySeconds: 30
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 3
          startup:
            enabled: true
            type: EXEC
            spec:
              command:
                - /bin/sh
                - -c
                - mariadb-admin ping -uroot -p${MARIADB_ROOT_PASSWORD}
              initialDelaySeconds: 10
              periodSeconds: 5
              timeoutSeconds: 5
              failureThreshold: 30

        resources:
          requests:
            cpu: 500m
            memory: 512Mi
            ephemeral-storage: 50Mi
          limits:
            cpu: 750m
            memory: 768Mi
            ephemeral-storage: 2Gi

        securityContext:
          runAsNonRoot: true
          runAsUser: 999  # mysql user
          readOnlyRootFilesystem: false
          allowPrivilegeEscalation: false
          seccompProfile:
            type: RuntimeDefault
          capabilities:
            drop:
              - ALL
            add:
              - CHOWN
              - SETGID
              - SETUID

service:
  # WordPress service
  wordpress:
    enabled: true
    controller: wordpress
    type: ClusterIP
    ports:
      http:
        enabled: true
        port: 80
        protocol: HTTP

  # MariaDB service
  mariadb:
    enabled: true
    controller: mariadb
    type: ClusterIP
    ports:
      mysql:
        enabled: true
        port: 3306
        protocol: TCP

  # MariaDB headless service (for StatefulSet)
  mariadb-headless:
    enabled: true
    controller: mariadb
    type: ClusterIP
    clusterIP: None
    ports:
      mysql:
        enabled: true
        port: 3306
        protocol: TCP

persistence:
  # WordPress persistent storage
  wordpress-data:
    enabled: true
    type: persistentVolumeClaim
    storageClass: nfs-client
    accessMode: ReadWriteOnce
    size: 10Gi
    retain: true
    advancedMounts:
      wordpress:
        main:
          - path: /var/www/html
            readOnly: false

route:
  main:
    enabled: true
    kind: HTTPRoute
    parentRefs:
      - name: main
        namespace: envoy-gateway-system
        group: gateway.networking.k8s.io
        kind: Gateway
    hostnames:
      - www.mattgerega.com
    rules:
      - matches:
          - path:
              type: PathPrefix
              value: /
        backendRefs:
          - name: wp-mattgerega-com-wordpress
            port: 80
            weight: 1

configMaps: {}

secrets: {}
